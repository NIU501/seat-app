import React, { useState, useEffect, useCallback } from 'react';
import { Users, Lock, Play, RotateCcw, StopCircle, Loader } from 'lucide-react';
// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, runTransaction, updateDoc } from 'firebase/firestore';

// 고정된 전체 좌석 수
const TOTAL_SEATS = 31;
// 관리자 비밀번호 (로컬 테스트용) - 실제 배포 시에는 더 강력한 인증이 필요합니다.
const ADMIN_PASSWORD = '0501!'; 
// Firebase 전역 변수 설정 (Canvas 환경에서 제공됨)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let db, auth;
try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    // console.log("Firebase services initialized.");
} catch (error) {
    console.error("Firebase initialization error:", error);
}

// Firestore 문서 경로
const globalStateDocPath = `artifacts/${appId}/public/data/config/globalState`;

// --- Seat Assignment Application Component ---

export default function App() {
  // --- State Variables ---
  const [isFirebaseReady, setIsFirebaseReady] = useState(false);
  const [adminMode, setAdminMode] = useState(false);
  const [password, setPassword] = useState('');
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  
  // Real-time Data States (Synced with Firestore)
  const [ticketingActive, setTicketingActive] = useState(false); 
  const [seats, setSeats] = useState({}); // { seatNum: studentName }
  const [dataLoading, setDataLoading] = useState(true);

  // User/Client States
  const [studentName, setStudentName] = useState('');
  const [hasAssignedSeat, setHasAssignedSeat] = useState(false);
  const [processing, setProcessing] = useState(false);
  
  // Message & Modal States
  const [message, setMessage] = useState('');
  const [messageType, setMessageType] = useState('');
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [confirmAction, setConfirmAction] = useState(null); 
  const [confirmMessage, setConfirmMessage] = useState('');
  const [selectedSeat, setSelectedSeat] = useState(null);

  // 좌석 구조 정의
  const seatStructure = [
    { section: 1, rows: [[1, 2], [3, 4], [5, 6], [7, 8]] },
    { section: 2, rows: [[9, 10], [11, 12], [13, 14], [15, 16]] },
    { section: 3, rows: [[17, 18], [19, 20], [21, 22], [23, 24]] },
    { section: 4, rows: [
        [25, 26], 
        [27, 28], 
        [29, 30], 
        ['EMPTY', 31]
    ]} 
  ];

  // --- Firebase Initialization and Real-time Listener ---

  useEffect(() => {
    let unsubscribe = () => {};
    
    const initFirebase = async () => {
      if (!db || !auth) {
        console.error("Firebase services are not available.");
        setDataLoading(false);
        return;
      }

      try {
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }
        setIsFirebaseReady(true);
        // console.log("User signed in.");
      } catch (error) {
        console.error("Firebase Authentication failed:", error);
        setIsFirebaseReady(true); // Attempt to proceed even if auth fails
        setDataLoading(false);
        return;
      }
      
      // 2. Real-time Data Listener
      const docRef = doc(db, globalStateDocPath);
      
      unsubscribe = onSnapshot(docRef, (docSnapshot) => {
        setDataLoading(false);
        if (docSnapshot.exists()) {
          const data = docSnapshot.data();
          setSeats(data.seats || {});
          setTicketingActive(!!data.ticketingActive);
        //   console.log("Real-time data updated:", data);
        } else {
          // Document does not exist, initialize it (e.g., on first run)
          setDoc(docRef, { seats: {}, ticketingActive: false }).catch(e => console.error("Initial doc set error:", e));
        }
      }, (error) => {
        console.error("Firestore snapshot error:", error);
        setDataLoading(false);
      });
    };

    initFirebase();
    
    // Cleanup listener on component unmount
    return () => unsubscribe();
  }, []); 
  
  // --- Derived State: Check if the current student has a seat ---
  useEffect(() => {
      const existingSeat = Object.keys(seats).find(key => seats[key] === studentName.trim());
      setHasAssignedSeat(!!existingSeat);
  }, [seats, studentName]);

  // --- Utility Functions ---

  const showMessage = (msg, type) => {
    setMessage(msg);
    setMessageType(type);
    setTimeout(() => {
      setMessage('');
      setMessageType('');
    }, 3000);
  };

  // --- Admin Logic ---

  const handlePasswordSubmit = () => {
    if (password === ADMIN_PASSWORD) {
      setAdminMode(true);
      setShowPasswordModal(false);
      setPassword('');
      showMessage('관리자 모드가 활성화되었습니다', 'success');
    } else {
      showMessage('비밀번호가 올바르지 않습니다', 'error');
      setPassword('');
    }
  };

  const startTicketing = async () => {
    if (!db) return showMessage('DB 연결 실패', 'error');
    try {
        await updateDoc(doc(db, globalStateDocPath), { ticketingActive: true });
        showMessage('티켓팅이 시작되었습니다!', 'success');
    } catch (e) {
        console.error("Error starting ticketing:", e);
        showMessage('티켓팅 시작 실패', 'error');
    }
  };

  const stopTicketing = async () => {
    if (!db) return showMessage('DB 연결 실패', 'error');
    try {
        await updateDoc(doc(db, globalStateDocPath), { ticketingActive: false });
        showMessage('티켓팅이 종료되었습니다', 'info');
    } catch (e) {
        console.error("Error stopping ticketing:", e);
        showMessage('티켓팅 종료 실패', 'error');
    }
  };

  const handleReset = () => {
    setConfirmMessage('모든 자리 배정을 초기화하고 티켓팅 상태를 비활성화하시겠습니까? (DB 데이터가 영구 삭제됩니다)');
    setConfirmAction(() => async () => {
        if (!db) return showMessage('DB 연결 실패', 'error');
        try {
            await setDoc(doc(db, globalStateDocPath), { seats: {}, ticketingActive: false });
            setStudentName('');
            showMessage('초기화가 완료되었습니다', 'info');
            setShowConfirmModal(false);
        } catch (e) {
            console.error("Error resetting data:", e);
            showMessage('초기화 실패', 'error');
            setShowConfirmModal(false);
        }
    });
    setShowConfirmModal(true);
  };
  
  // 관리자 모드에서 배정된 자리 클릭 시 취소 처리
  const handleAdminSeatCancel = (seatNum) => {
    setConfirmMessage(`${seats[seatNum]}님의 ${seatNum}번 좌석 배정을 취소하시겠습니까?`);
    setConfirmAction(() => async () => {
        if (!db) return showMessage('DB 연결 실패', 'error');
        try {
            const newSeats = { ...seats };
            delete newSeats[seatNum];
            await updateDoc(doc(db, globalStateDocPath), { seats: newSeats });
            showMessage('좌석 배정이 취소되었습니다', 'info');
            setShowConfirmModal(false);
        } catch (e) {
            console.error("Error cancelling seat:", e);
            showMessage('취소 실패', 'error');
            setShowConfirmModal(false);
        }
    });
    setShowConfirmModal(true);
  };


  // --- Student Seat Assignment Logic (Firestore Transaction) ---

  const handleSeatClick = async (seatNum) => {
    // 1. 관리자 취소 모드
    if (adminMode && seats[seatNum]) {
      handleAdminSeatCancel(seatNum);
      return;
    }
    
    // 'EMPTY' 자리 클릭은 무시
    if (seatNum === 'EMPTY') return;

    // 2. 일반 사용자 모드 제어 및 유효성 검사
    if (!ticketingActive || processing || seats[seatNum]) return;
    
    const name = studentName.trim();
    if (!name) {
      showMessage('이름을 먼저 입력해주세요!', 'error');
      return;
    }

    if (hasAssignedSeat) {
        showMessage('이미 좌석 배정에 성공했습니다. 추가 배정은 관리자에게 문의하세요.', 'error');
        return;
    }
    
    setProcessing(true);
    setSelectedSeat(seatNum);

    if (!db) {
        setProcessing(false);
        return showMessage('DB 연결 실패. 배정할 수 없습니다.', 'error');
    }

    // Firestore Transaction을 사용하여 원자성 보장 (동시 접근 처리)
    const docRef = doc(db, globalStateDocPath);

    try {
        await runTransaction(db, async (transaction) => {
            const docSnapshot = await transaction.get(docRef);
            if (!docSnapshot.exists()) {
                throw new Error("데이터베이스 문서가 초기화되지 않았습니다. 잠시 후 다시 시도해주세요.");
            }
            
            const currentData = docSnapshot.data();
            const currentSeats = currentData.seats || {};

            // 1. 최종적으로 이 좌석이 비어있는지 확인
            if (currentSeats[seatNum]) {
                throw new Error(`이미 ${currentSeats[seatNum]}에게 배정된 좌석입니다.`);
            }

            // 2. 이름 중복 체크 (트랜잭션 내부에서 확인)
            const existingSeatNum = Object.keys(currentSeats).find(key => currentSeats[key] === name);
            if (existingSeatNum) {
                throw new Error(`${name}님은 이미 ${existingSeatNum}번 좌석을 배정받았습니다.`);
            }

            // 3. 배정 진행
            const newSeats = { ...currentSeats, [seatNum]: name };
            transaction.update(docRef, { seats: newSeats });
        });

        // 트랜잭션 성공 후 (UI 업데이트는 onSnapshot이 처리하지만, 즉시 피드백 제공)
        showMessage(`${name}님, ${seatNum}번 좌석 배정 완료!`, 'success');
        
    } catch (e) {
        if (e.message.includes("이미")) {
             showMessage(e.message, 'error');
        } else {
            console.error("Seat assignment transaction failed:", e);
            showMessage('좌석 배정 실패. 잠시 후 다시 시도해주세요.', 'error');
        }
    } finally {
        setSelectedSeat(null);
        setProcessing(false);
    }
  };

  // --- UI Styling Helpers ---

  const getSeatColor = (seatNum) => {
    if (seats[seatNum]) {
        return adminMode 
            ? 'bg-blue-600 text-white hover:bg-red-500 cursor-pointer shadow-xl'
            : 'bg-blue-600 text-white cursor-default shadow-xl';
    }
    
    if (selectedSeat === seatNum && processing) return 'bg-yellow-400 text-gray-900 animate-pulse ring-4 ring-yellow-500 ring-opacity-70';

    if (processing || !ticketingActive) return 'bg-gray-200 text-gray-500 cursor-not-allowed shadow-inner';

    const baseColor = 'bg-green-100 hover:bg-green-300 text-gray-700';
    return `${baseColor} cursor-pointer shadow-md`;
  };
  
  const getSeatClass = () => 'w-20 h-20';

  const getMessageColor = () => {
    if (messageType === 'success') return 'bg-green-600';
    if (messageType === 'error') return 'bg-red-600';
    return 'bg-indigo-600';
  };
  
  // 이름 입력 필드의 비활성화 상태: 배정 시도 중이거나 이미 배정에 성공한 경우
  const isNameInputDisabled = processing || hasAssignedSeat || dataLoading;
  
  // 로딩 상태 표시
  if (dataLoading) {
    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans">
            <div className="text-center p-8 bg-white rounded-xl shadow-2xl">
                <Loader className="w-10 h-10 text-indigo-500 mx-auto mb-4 animate-spin" />
                <h2 className="text-2xl font-bold text-gray-800">데이터 로딩 중...</h2>
                <p className="text-gray-600 mt-2">좌석 정보를 데이터베이스에서 불러오고 있습니다.</p>
            </div>
        </div>
    );
  }


  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans antialiased">
      {/* Tailwind CSS Script */}
      <script src="https://cdn.tailwindcss.com"></script>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
      `}</style>
      
      <div className="max-w-7xl mx-auto">
        
        {/* 메시지 알림, 확인 모달, 비밀번호 모달... (이전과 동일) */}
        {message && (
          <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 ${getMessageColor()} text-white px-6 py-3 rounded-xl shadow-2xl z-50 font-bold text-lg transition-all duration-300 ease-out border-b-4 ${messageType === 'success' ? 'border-green-800' : 'border-red-800'}`}>
            {message}
          </div>
        )}

        {showConfirmModal && (
          <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl p-8 max-w-lg w-full shadow-2xl">
              <h2 className="text-2xl font-extrabold text-gray-800 mb-4">⚠️ 확인 필요</h2>
              <p className="text-gray-700 mb-8 leading-relaxed">{confirmMessage}</p>
              <div className="flex gap-4">
                <button
                  onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }}
                  className="flex-1 px-4 py-3 bg-gray-300 text-gray-800 rounded-xl font-bold hover:bg-gray-400 transition transform hover:scale-105"
                >
                  취소
                </button>
                <button
                  onClick={() => confirmAction && confirmAction()}
                  className="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition transform hover:scale-105 shadow-lg shadow-indigo-300"
                >
                  확인 및 진행
                </button>
              </div>
            </div>
          </div>
        )}

        {showPasswordModal && (
          <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl p-8 max-w-sm w-full shadow-2xl">
              <h2 className="text-2xl font-bold text-gray-800 mb-5">관리자 인증</h2>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handlePasswordSubmit()}
                placeholder="비밀번호를 입력하세요"
                className="w-full px-5 py-3 border-2 border-indigo-400 rounded-xl focus:ring-4 focus:ring-indigo-300 focus:border-indigo-500 mb-6 text-lg"
                autoFocus
              />
              <div className="flex gap-4">
                <button
                  onClick={handlePasswordSubmit}
                  className="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition transform hover:scale-105 shadow-lg shadow-indigo-300"
                >
                  로그인
                </button>
                <button
                  onClick={() => { setShowPasswordModal(false); setPassword(''); }}
                  className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 transition"
                >
                  닫기
                </button>
              </div>
            </div>
          </div>
        )}

        {/* 헤더 및 컨트롤 패널 */}
        <div className="bg-white rounded-2xl shadow-2xl p-6 mb-8 border-b-4 border-indigo-500">
          <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <Users className="w-10 h-10 text-indigo-600" />
              <h1 className="text-4xl font-extrabold text-gray-800">실시간 좌석 배치 시스템 (DB 연동)</h1>
              {ticketingActive && (
                <span className="bg-red-500 text-white px-4 py-1.5 rounded-full text-sm font-bold animate-pulse shadow-md border-2 border-white">
                  LIVE 티켓팅 중
                </span>
              )}
            </div>
            
            <button
              onClick={() => {
                if (adminMode) {
                  setAdminMode(false);
                  showMessage('관리자 모드가 종료되었습니다', 'info');
                } else {
                  setShowPasswordModal(true);
                }
              }}
              className={`flex items-center gap-2 px-5 py-2.5 rounded-xl font-bold transition transform hover:scale-105 shadow-lg ${
                adminMode
                  ? 'bg-indigo-600 text-white shadow-indigo-400'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-gray-400'
              }`}
            >
              <Lock className="w-5 h-5" />
              {adminMode ? '관리자 모드 (종료)' : '관리자 로그인'}
            </button>
          </div>

          {/* 통계 */}
          <div className="mt-5 flex gap-8 text-md text-gray-600 font-semibold border-t border-gray-100 pt-4">
            <span>총 좌석: <span className="text-gray-800 font-extrabold">{TOTAL_SEATS}개</span></span>
            <span>배정 완료: <span className="text-blue-600 font-extrabold">{Object.keys(seats).length}명</span></span>
            <span>남은 좌석: <span className="text-green-600 font-extrabold">{TOTAL_SEATS - Object.keys(seats).length}개</span></span>
          </div>
        </div>

        {/* 관리자 컨트롤 */}
        {adminMode && (
          <div className="bg-white rounded-2xl shadow-xl p-6 mb-8 border-l-4 border-green-500">
            <h2 className="text-xl font-bold text-gray-800 mb-4">관리자 제어판 (DB 연동)</h2>
            <div className="flex gap-4 flex-wrap">
              {!ticketingActive ? (
                <button
                  onClick={startTicketing}
                  className="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-lg shadow-green-300 transform hover:scale-105"
                >
                  <Play className="w-5 h-5" />
                  티켓팅 시작
                </button>
              ) : (
                <button
                  onClick={stopTicketing}
                  className="flex items-center gap-2 px-6 py-3 bg-orange-600 text-white rounded-xl font-bold hover:bg-orange-700 transition shadow-lg shadow-orange-300 transform hover:scale-105"
                >
                  <StopCircle className="w-5 h-5" />
                  티켓팅 정지
                </button>
              )}
              <button
                onClick={handleReset}
                className="flex items-center gap-2 px-6 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition shadow-lg shadow-red-300 transform hover:scale-105"
              >
                <RotateCcw className="w-5 h-5" />
                전체 초기화
              </button>
            </div>
            <p className="mt-3 text-sm text-gray-600">
              ⚠️ 주의: 이제 이 기능들은 데이터베이스에 직접 반영되며, 접속한 모든 사용자에게 즉시 업데이트됩니다.
            </p>
          </div>
        )}

        {/* 이름 입력 */}
        <div className="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <label className="block text-xl font-bold text-gray-800 mb-4">
                🙋 이름 입력 후 좌석 선택
            </label>
            <input
                type="text"
                value={studentName}
                onChange={(e) => setStudentName(e.target.value)}
                placeholder={ticketingActive ? "여기에 이름을 입력하세요" : "티켓팅 시작을 기다리는 중..."}
                disabled={isNameInputDisabled}
                className="w-full px-5 py-3 text-xl border-2 border-indigo-400 rounded-xl focus:ring-4 focus:ring-indigo-300 focus:border-indigo-500 disabled:bg-gray-100 disabled:text-gray-500 transition"
            />
            {hasAssignedSeat && (
                <p className="mt-4 text-green-600 font-bold text-lg">
                    ✅ 좌석 배정 성공! ({Object.keys(seats).find(key => seats[key] === studentName.trim())}번) 이름 입력란은 비활성화되었습니다.
                </p>
            )}
            {processing && (
                <p className="mt-4 text-indigo-600 font-bold text-lg animate-bounce">
                    <span className="animate-spin inline-block mr-2">⚙️</span> 좌석 배정 중... 잠시만 기다려주세요! (DB 트랜잭션 진행 중)
                </p>
            )}
        </div>

        {/* 교실 레이아웃 */}
        <div id="classroom-layout" className="bg-white rounded-2xl shadow-2xl p-8 overflow-x-auto border-4 border-gray-100">
          <div className="min-w-max flex flex-col items-start mx-auto gap-8">
            
            {/* 교탁 배치 */}
            <div className="ml-[2.5rem] flex justify-center">
                <div className="bg-gray-800 text-white px-6 py-2 rounded-lg font-bold text-xl shadow-xl w-40 text-center">
                    교탁
                </div>
            </div>

            {/* 좌석 배치 */}
            <div className="flex justify-start gap-8">
              {seatStructure.map((section) => (
                <div key={section.section} className="flex flex-col items-center">
                  <div className="space-y-4">
                    {section.rows.map((row, rowIdx) => (
                      <div key={rowIdx} className="flex gap-3">
                        {row.map((seatItem) => {
                          if (seatItem === 'EMPTY') {
                            return (
                              <div key={`empty-${rowIdx}`} 
                                   className="w-20 h-20 rounded-xl bg-gray-100 text-gray-400 flex items-center justify-center font-bold text-lg shadow-inner cursor-default select-none">
                                X
                              </div>
                            );
                          }

                          const seatNum = seatItem;
                          return (
                            <button
                              key={seatNum}
                              onClick={() => handleSeatClick(seatNum)}
                              disabled={!ticketingActive && !adminMode || processing}
                              className={`rounded-xl font-extrabold transition-all duration-200 transform shadow-lg text-sm flex flex-col items-center justify-center 
                                ${getSeatColor(seatNum)}
                                ${getSeatClass(seatNum)}
                                ${seats[seatNum] ? 'hover:scale-100' : 'hover:scale-105'}
                              `}
                            >
                              <div className={`text-xs opacity-70 mb-1`}>{seatNum}번</div>
                              <div className={`text-sm mt-1 px-1 truncate w-full ${seats[seatNum] ? 'text-white font-bold' : 'font-semibold'}`}>
                                {seats[seatNum] || ''}
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    ))}
                  </div>
                  {section.section < seatStructure.length && (
                    <div className="w-1 h-full bg-gray-100 mx-4"></div>
                  )}
                </div>
              ))}
            </div>
          </div>

          {/* 범례 */}
          <div className="mt-10 pt-6 border-t border-gray-200 flex flex-wrap justify-center gap-6 text-sm font-semibold">
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-gray-200 border border-gray-400 rounded-lg shadow-inner"></div>
              <span>선택 불가/처리 중</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-green-100 border border-green-300 rounded-lg shadow-md"></div>
              <span className="text-green-700">선택 가능</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-yellow-400 rounded-lg shadow-lg animate-pulse"></div>
              <span className="text-yellow-700">배정 시도 중</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-blue-600 rounded-lg shadow-xl"></div>
              <span className="text-blue-700">배정 완료 (DB에 기록됨)</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
