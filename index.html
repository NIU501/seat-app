import React, { useState, useEffect, useCallback } from 'react';
import { Users, Lock, Play, RotateCcw, StopCircle, Loader } from 'lucide-react';
// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, runTransaction, updateDoc } from 'firebase/firestore';

// ê³ ì •ëœ ì „ì²´ ì¢Œì„ ìˆ˜
const TOTAL_SEATS = 31;
// ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©) - ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” ë” ê°•ë ¥í•œ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.
const ADMIN_PASSWORD = '0501!'; 
// Firebase ì „ì—­ ë³€ìˆ˜ ì„¤ì • (Canvas í™˜ê²½ì—ì„œ ì œê³µë¨)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let db, auth;
try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    // console.log("Firebase services initialized.");
} catch (error) {
    console.error("Firebase initialization error:", error);
}

// Firestore ë¬¸ì„œ ê²½ë¡œ
const globalStateDocPath = `artifacts/${appId}/public/data/config/globalState`;

// --- Seat Assignment Application Component ---

export default function App() {
  // --- State Variables ---
  const [isFirebaseReady, setIsFirebaseReady] = useState(false);
  const [adminMode, setAdminMode] = useState(false);
  const [password, setPassword] = useState('');
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  
  // Real-time Data States (Synced with Firestore)
  const [ticketingActive, setTicketingActive] = useState(false); 
  const [seats, setSeats] = useState({}); // { seatNum: studentName }
  const [dataLoading, setDataLoading] = useState(true);

  // User/Client States
  const [studentName, setStudentName] = useState('');
  const [hasAssignedSeat, setHasAssignedSeat] = useState(false);
  const [processing, setProcessing] = useState(false);
  
  // Message & Modal States
  const [message, setMessage] = useState('');
  const [messageType, setMessageType] = useState('');
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [confirmAction, setConfirmAction] = useState(null); 
  const [confirmMessage, setConfirmMessage] = useState('');
  const [selectedSeat, setSelectedSeat] = useState(null);

  // ì¢Œì„ êµ¬ì¡° ì •ì˜
  const seatStructure = [
    { section: 1, rows: [[1, 2], [3, 4], [5, 6], [7, 8]] },
    { section: 2, rows: [[9, 10], [11, 12], [13, 14], [15, 16]] },
    { section: 3, rows: [[17, 18], [19, 20], [21, 22], [23, 24]] },
    { section: 4, rows: [
        [25, 26], 
        [27, 28], 
        [29, 30], 
        ['EMPTY', 31]
    ]} 
  ];

  // --- Firebase Initialization and Real-time Listener ---

  useEffect(() => {
    let unsubscribe = () => {};
    
    const initFirebase = async () => {
      if (!db || !auth) {
        console.error("Firebase services are not available.");
        setDataLoading(false);
        return;
      }

      try {
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }
        setIsFirebaseReady(true);
        // console.log("User signed in.");
      } catch (error) {
        console.error("Firebase Authentication failed:", error);
        setIsFirebaseReady(true); // Attempt to proceed even if auth fails
        setDataLoading(false);
        return;
      }
      
      // 2. Real-time Data Listener
      const docRef = doc(db, globalStateDocPath);
      
      unsubscribe = onSnapshot(docRef, (docSnapshot) => {
        setDataLoading(false);
        if (docSnapshot.exists()) {
          const data = docSnapshot.data();
          setSeats(data.seats || {});
          setTicketingActive(!!data.ticketingActive);
        //   console.log("Real-time data updated:", data);
        } else {
          // Document does not exist, initialize it (e.g., on first run)
          setDoc(docRef, { seats: {}, ticketingActive: false }).catch(e => console.error("Initial doc set error:", e));
        }
      }, (error) => {
        console.error("Firestore snapshot error:", error);
        setDataLoading(false);
      });
    };

    initFirebase();
    
    // Cleanup listener on component unmount
    return () => unsubscribe();
  }, []); 
  
  // --- Derived State: Check if the current student has a seat ---
  useEffect(() => {
      const existingSeat = Object.keys(seats).find(key => seats[key] === studentName.trim());
      setHasAssignedSeat(!!existingSeat);
  }, [seats, studentName]);

  // --- Utility Functions ---

  const showMessage = (msg, type) => {
    setMessage(msg);
    setMessageType(type);
    setTimeout(() => {
      setMessage('');
      setMessageType('');
    }, 3000);
  };

  // --- Admin Logic ---

  const handlePasswordSubmit = () => {
    if (password === ADMIN_PASSWORD) {
      setAdminMode(true);
      setShowPasswordModal(false);
      setPassword('');
      showMessage('ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    } else {
      showMessage('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
      setPassword('');
    }
  };

  const startTicketing = async () => {
    if (!db) return showMessage('DB ì—°ê²° ì‹¤íŒ¨', 'error');
    try {
        await updateDoc(doc(db, globalStateDocPath), { ticketingActive: true });
        showMessage('í‹°ì¼“íŒ…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    } catch (e) {
        console.error("Error starting ticketing:", e);
        showMessage('í‹°ì¼“íŒ… ì‹œì‘ ì‹¤íŒ¨', 'error');
    }
  };

  const stopTicketing = async () => {
    if (!db) return showMessage('DB ì—°ê²° ì‹¤íŒ¨', 'error');
    try {
        await updateDoc(doc(db, globalStateDocPath), { ticketingActive: false });
        showMessage('í‹°ì¼“íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
    } catch (e) {
        console.error("Error stopping ticketing:", e);
        showMessage('í‹°ì¼“íŒ… ì¢…ë£Œ ì‹¤íŒ¨', 'error');
    }
  };

  const handleReset = () => {
    setConfirmMessage('ëª¨ë“  ìë¦¬ ë°°ì •ì„ ì´ˆê¸°í™”í•˜ê³  í‹°ì¼“íŒ… ìƒíƒœë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (DB ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤)');
    setConfirmAction(() => async () => {
        if (!db) return showMessage('DB ì—°ê²° ì‹¤íŒ¨', 'error');
        try {
            await setDoc(doc(db, globalStateDocPath), { seats: {}, ticketingActive: false });
            setStudentName('');
            showMessage('ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            setShowConfirmModal(false);
        } catch (e) {
            console.error("Error resetting data:", e);
            showMessage('ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
            setShowConfirmModal(false);
        }
    });
    setShowConfirmModal(true);
  };
  
  // ê´€ë¦¬ì ëª¨ë“œì—ì„œ ë°°ì •ëœ ìë¦¬ í´ë¦­ ì‹œ ì·¨ì†Œ ì²˜ë¦¬
  const handleAdminSeatCancel = (seatNum) => {
    setConfirmMessage(`${seats[seatNum]}ë‹˜ì˜ ${seatNum}ë²ˆ ì¢Œì„ ë°°ì •ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    setConfirmAction(() => async () => {
        if (!db) return showMessage('DB ì—°ê²° ì‹¤íŒ¨', 'error');
        try {
            const newSeats = { ...seats };
            delete newSeats[seatNum];
            await updateDoc(doc(db, globalStateDocPath), { seats: newSeats });
            showMessage('ì¢Œì„ ë°°ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            setShowConfirmModal(false);
        } catch (e) {
            console.error("Error cancelling seat:", e);
            showMessage('ì·¨ì†Œ ì‹¤íŒ¨', 'error');
            setShowConfirmModal(false);
        }
    });
    setShowConfirmModal(true);
  };


  // --- Student Seat Assignment Logic (Firestore Transaction) ---

  const handleSeatClick = async (seatNum) => {
    // 1. ê´€ë¦¬ì ì·¨ì†Œ ëª¨ë“œ
    if (adminMode && seats[seatNum]) {
      handleAdminSeatCancel(seatNum);
      return;
    }
    
    // 'EMPTY' ìë¦¬ í´ë¦­ì€ ë¬´ì‹œ
    if (seatNum === 'EMPTY') return;

    // 2. ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ ì œì–´ ë° ìœ íš¨ì„± ê²€ì‚¬
    if (!ticketingActive || processing || seats[seatNum]) return;
    
    const name = studentName.trim();
    if (!name) {
      showMessage('ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
      return;
    }

    if (hasAssignedSeat) {
        showMessage('ì´ë¯¸ ì¢Œì„ ë°°ì •ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ì¶”ê°€ ë°°ì •ì€ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
        return;
    }
    
    setProcessing(true);
    setSelectedSeat(seatNum);

    if (!db) {
        setProcessing(false);
        return showMessage('DB ì—°ê²° ì‹¤íŒ¨. ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    }

    // Firestore Transactionì„ ì‚¬ìš©í•˜ì—¬ ì›ìì„± ë³´ì¥ (ë™ì‹œ ì ‘ê·¼ ì²˜ë¦¬)
    const docRef = doc(db, globalStateDocPath);

    try {
        await runTransaction(db, async (transaction) => {
            const docSnapshot = await transaction.get(docRef);
            if (!docSnapshot.exists()) {
                throw new Error("ë°ì´í„°ë² ì´ìŠ¤ ë¬¸ì„œê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
            
            const currentData = docSnapshot.data();
            const currentSeats = currentData.seats || {};

            // 1. ìµœì¢…ì ìœ¼ë¡œ ì´ ì¢Œì„ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
            if (currentSeats[seatNum]) {
                throw new Error(`ì´ë¯¸ ${currentSeats[seatNum]}ì—ê²Œ ë°°ì •ëœ ì¢Œì„ì…ë‹ˆë‹¤.`);
            }

            // 2. ì´ë¦„ ì¤‘ë³µ ì²´í¬ (íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ í™•ì¸)
            const existingSeatNum = Object.keys(currentSeats).find(key => currentSeats[key] === name);
            if (existingSeatNum) {
                throw new Error(`${name}ë‹˜ì€ ì´ë¯¸ ${existingSeatNum}ë²ˆ ì¢Œì„ì„ ë°°ì •ë°›ì•˜ìŠµë‹ˆë‹¤.`);
            }

            // 3. ë°°ì • ì§„í–‰
            const newSeats = { ...currentSeats, [seatNum]: name };
            transaction.update(docRef, { seats: newSeats });
        });

        // íŠ¸ëœì­ì…˜ ì„±ê³µ í›„ (UI ì—…ë°ì´íŠ¸ëŠ” onSnapshotì´ ì²˜ë¦¬í•˜ì§€ë§Œ, ì¦‰ì‹œ í”¼ë“œë°± ì œê³µ)
        showMessage(`${name}ë‹˜, ${seatNum}ë²ˆ ì¢Œì„ ë°°ì • ì™„ë£Œ!`, 'success');
        
    } catch (e) {
        if (e.message.includes("ì´ë¯¸")) {
             showMessage(e.message, 'error');
        } else {
            console.error("Seat assignment transaction failed:", e);
            showMessage('ì¢Œì„ ë°°ì • ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
        }
    } finally {
        setSelectedSeat(null);
        setProcessing(false);
    }
  };

  // --- UI Styling Helpers ---

  const getSeatColor = (seatNum) => {
    if (seats[seatNum]) {
        return adminMode 
            ? 'bg-blue-600 text-white hover:bg-red-500 cursor-pointer shadow-xl'
            : 'bg-blue-600 text-white cursor-default shadow-xl';
    }
    
    if (selectedSeat === seatNum && processing) return 'bg-yellow-400 text-gray-900 animate-pulse ring-4 ring-yellow-500 ring-opacity-70';

    if (processing || !ticketingActive) return 'bg-gray-200 text-gray-500 cursor-not-allowed shadow-inner';

    const baseColor = 'bg-green-100 hover:bg-green-300 text-gray-700';
    return `${baseColor} cursor-pointer shadow-md`;
  };
  
  const getSeatClass = () => 'w-20 h-20';

  const getMessageColor = () => {
    if (messageType === 'success') return 'bg-green-600';
    if (messageType === 'error') return 'bg-red-600';
    return 'bg-indigo-600';
  };
  
  // ì´ë¦„ ì…ë ¥ í•„ë“œì˜ ë¹„í™œì„±í™” ìƒíƒœ: ë°°ì • ì‹œë„ ì¤‘ì´ê±°ë‚˜ ì´ë¯¸ ë°°ì •ì— ì„±ê³µí•œ ê²½ìš°
  const isNameInputDisabled = processing || hasAssignedSeat || dataLoading;
  
  // ë¡œë”© ìƒíƒœ í‘œì‹œ
  if (dataLoading) {
    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans">
            <div className="text-center p-8 bg-white rounded-xl shadow-2xl">
                <Loader className="w-10 h-10 text-indigo-500 mx-auto mb-4 animate-spin" />
                <h2 className="text-2xl font-bold text-gray-800">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
                <p className="text-gray-600 mt-2">ì¢Œì„ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    );
  }


  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans antialiased">
      {/* Tailwind CSS Script */}
      <script src="https://cdn.tailwindcss.com"></script>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
      `}</style>
      
      <div className="max-w-7xl mx-auto">
        
        {/* ë©”ì‹œì§€ ì•Œë¦¼, í™•ì¸ ëª¨ë‹¬, ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬... (ì´ì „ê³¼ ë™ì¼) */}
        {message && (
          <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 ${getMessageColor()} text-white px-6 py-3 rounded-xl shadow-2xl z-50 font-bold text-lg transition-all duration-300 ease-out border-b-4 ${messageType === 'success' ? 'border-green-800' : 'border-red-800'}`}>
            {message}
          </div>
        )}

        {showConfirmModal && (
          <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl p-8 max-w-lg w-full shadow-2xl">
              <h2 className="text-2xl font-extrabold text-gray-800 mb-4">âš ï¸ í™•ì¸ í•„ìš”</h2>
              <p className="text-gray-700 mb-8 leading-relaxed">{confirmMessage}</p>
              <div className="flex gap-4">
                <button
                  onClick={() => { setShowConfirmModal(false); setConfirmAction(null); }}
                  className="flex-1 px-4 py-3 bg-gray-300 text-gray-800 rounded-xl font-bold hover:bg-gray-400 transition transform hover:scale-105"
                >
                  ì·¨ì†Œ
                </button>
                <button
                  onClick={() => confirmAction && confirmAction()}
                  className="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition transform hover:scale-105 shadow-lg shadow-indigo-300"
                >
                  í™•ì¸ ë° ì§„í–‰
                </button>
              </div>
            </div>
          </div>
        )}

        {showPasswordModal && (
          <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl p-8 max-w-sm w-full shadow-2xl">
              <h2 className="text-2xl font-bold text-gray-800 mb-5">ê´€ë¦¬ì ì¸ì¦</h2>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handlePasswordSubmit()}
                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                className="w-full px-5 py-3 border-2 border-indigo-400 rounded-xl focus:ring-4 focus:ring-indigo-300 focus:border-indigo-500 mb-6 text-lg"
                autoFocus
              />
              <div className="flex gap-4">
                <button
                  onClick={handlePasswordSubmit}
                  className="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition transform hover:scale-105 shadow-lg shadow-indigo-300"
                >
                  ë¡œê·¸ì¸
                </button>
                <button
                  onClick={() => { setShowPasswordModal(false); setPassword(''); }}
                  className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 transition"
                >
                  ë‹«ê¸°
                </button>
              </div>
            </div>
          </div>
        )}

        {/* í—¤ë” ë° ì»¨íŠ¸ë¡¤ íŒ¨ë„ */}
        <div className="bg-white rounded-2xl shadow-2xl p-6 mb-8 border-b-4 border-indigo-500">
          <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <Users className="w-10 h-10 text-indigo-600" />
              <h1 className="text-4xl font-extrabold text-gray-800">ì‹¤ì‹œê°„ ì¢Œì„ ë°°ì¹˜ ì‹œìŠ¤í…œ (DB ì—°ë™)</h1>
              {ticketingActive && (
                <span className="bg-red-500 text-white px-4 py-1.5 rounded-full text-sm font-bold animate-pulse shadow-md border-2 border-white">
                  LIVE í‹°ì¼“íŒ… ì¤‘
                </span>
              )}
            </div>
            
            <button
              onClick={() => {
                if (adminMode) {
                  setAdminMode(false);
                  showMessage('ê´€ë¦¬ì ëª¨ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                } else {
                  setShowPasswordModal(true);
                }
              }}
              className={`flex items-center gap-2 px-5 py-2.5 rounded-xl font-bold transition transform hover:scale-105 shadow-lg ${
                adminMode
                  ? 'bg-indigo-600 text-white shadow-indigo-400'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-gray-400'
              }`}
            >
              <Lock className="w-5 h-5" />
              {adminMode ? 'ê´€ë¦¬ì ëª¨ë“œ (ì¢…ë£Œ)' : 'ê´€ë¦¬ì ë¡œê·¸ì¸'}
            </button>
          </div>

          {/* í†µê³„ */}
          <div className="mt-5 flex gap-8 text-md text-gray-600 font-semibold border-t border-gray-100 pt-4">
            <span>ì´ ì¢Œì„: <span className="text-gray-800 font-extrabold">{TOTAL_SEATS}ê°œ</span></span>
            <span>ë°°ì • ì™„ë£Œ: <span className="text-blue-600 font-extrabold">{Object.keys(seats).length}ëª…</span></span>
            <span>ë‚¨ì€ ì¢Œì„: <span className="text-green-600 font-extrabold">{TOTAL_SEATS - Object.keys(seats).length}ê°œ</span></span>
          </div>
        </div>

        {/* ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ */}
        {adminMode && (
          <div className="bg-white rounded-2xl shadow-xl p-6 mb-8 border-l-4 border-green-500">
            <h2 className="text-xl font-bold text-gray-800 mb-4">ê´€ë¦¬ì ì œì–´íŒ (DB ì—°ë™)</h2>
            <div className="flex gap-4 flex-wrap">
              {!ticketingActive ? (
                <button
                  onClick={startTicketing}
                  className="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-lg shadow-green-300 transform hover:scale-105"
                >
                  <Play className="w-5 h-5" />
                  í‹°ì¼“íŒ… ì‹œì‘
                </button>
              ) : (
                <button
                  onClick={stopTicketing}
                  className="flex items-center gap-2 px-6 py-3 bg-orange-600 text-white rounded-xl font-bold hover:bg-orange-700 transition shadow-lg shadow-orange-300 transform hover:scale-105"
                >
                  <StopCircle className="w-5 h-5" />
                  í‹°ì¼“íŒ… ì •ì§€
                </button>
              )}
              <button
                onClick={handleReset}
                className="flex items-center gap-2 px-6 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition shadow-lg shadow-red-300 transform hover:scale-105"
              >
                <RotateCcw className="w-5 h-5" />
                ì „ì²´ ì´ˆê¸°í™”
              </button>
            </div>
            <p className="mt-3 text-sm text-gray-600">
              âš ï¸ ì£¼ì˜: ì´ì œ ì´ ê¸°ëŠ¥ë“¤ì€ ë°ì´í„°ë² ì´ìŠ¤ì— ì§ì ‘ ë°˜ì˜ë˜ë©°, ì ‘ì†í•œ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
            </p>
          </div>
        )}

        {/* ì´ë¦„ ì…ë ¥ */}
        <div className="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <label className="block text-xl font-bold text-gray-800 mb-4">
                ğŸ™‹ ì´ë¦„ ì…ë ¥ í›„ ì¢Œì„ ì„ íƒ
            </label>
            <input
                type="text"
                value={studentName}
                onChange={(e) => setStudentName(e.target.value)}
                placeholder={ticketingActive ? "ì—¬ê¸°ì— ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" : "í‹°ì¼“íŒ… ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."}
                disabled={isNameInputDisabled}
                className="w-full px-5 py-3 text-xl border-2 border-indigo-400 rounded-xl focus:ring-4 focus:ring-indigo-300 focus:border-indigo-500 disabled:bg-gray-100 disabled:text-gray-500 transition"
            />
            {hasAssignedSeat && (
                <p className="mt-4 text-green-600 font-bold text-lg">
                    âœ… ì¢Œì„ ë°°ì • ì„±ê³µ! ({Object.keys(seats).find(key => seats[key] === studentName.trim())}ë²ˆ) ì´ë¦„ ì…ë ¥ë€ì€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
                </p>
            )}
            {processing && (
                <p className="mt-4 text-indigo-600 font-bold text-lg animate-bounce">
                    <span className="animate-spin inline-block mr-2">âš™ï¸</span> ì¢Œì„ ë°°ì • ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”! (DB íŠ¸ëœì­ì…˜ ì§„í–‰ ì¤‘)
                </p>
            )}
        </div>

        {/* êµì‹¤ ë ˆì´ì•„ì›ƒ */}
        <div id="classroom-layout" className="bg-white rounded-2xl shadow-2xl p-8 overflow-x-auto border-4 border-gray-100">
          <div className="min-w-max flex flex-col items-start mx-auto gap-8">
            
            {/* êµíƒ ë°°ì¹˜ */}
            <div className="ml-[2.5rem] flex justify-center">
                <div className="bg-gray-800 text-white px-6 py-2 rounded-lg font-bold text-xl shadow-xl w-40 text-center">
                    êµíƒ
                </div>
            </div>

            {/* ì¢Œì„ ë°°ì¹˜ */}
            <div className="flex justify-start gap-8">
              {seatStructure.map((section) => (
                <div key={section.section} className="flex flex-col items-center">
                  <div className="space-y-4">
                    {section.rows.map((row, rowIdx) => (
                      <div key={rowIdx} className="flex gap-3">
                        {row.map((seatItem) => {
                          if (seatItem === 'EMPTY') {
                            return (
                              <div key={`empty-${rowIdx}`} 
                                   className="w-20 h-20 rounded-xl bg-gray-100 text-gray-400 flex items-center justify-center font-bold text-lg shadow-inner cursor-default select-none">
                                X
                              </div>
                            );
                          }

                          const seatNum = seatItem;
                          return (
                            <button
                              key={seatNum}
                              onClick={() => handleSeatClick(seatNum)}
                              disabled={!ticketingActive && !adminMode || processing}
                              className={`rounded-xl font-extrabold transition-all duration-200 transform shadow-lg text-sm flex flex-col items-center justify-center 
                                ${getSeatColor(seatNum)}
                                ${getSeatClass(seatNum)}
                                ${seats[seatNum] ? 'hover:scale-100' : 'hover:scale-105'}
                              `}
                            >
                              <div className={`text-xs opacity-70 mb-1`}>{seatNum}ë²ˆ</div>
                              <div className={`text-sm mt-1 px-1 truncate w-full ${seats[seatNum] ? 'text-white font-bold' : 'font-semibold'}`}>
                                {seats[seatNum] || ''}
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    ))}
                  </div>
                  {section.section < seatStructure.length && (
                    <div className="w-1 h-full bg-gray-100 mx-4"></div>
                  )}
                </div>
              ))}
            </div>
          </div>

          {/* ë²”ë¡€ */}
          <div className="mt-10 pt-6 border-t border-gray-200 flex flex-wrap justify-center gap-6 text-sm font-semibold">
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-gray-200 border border-gray-400 rounded-lg shadow-inner"></div>
              <span>ì„ íƒ ë¶ˆê°€/ì²˜ë¦¬ ì¤‘</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-green-100 border border-green-300 rounded-lg shadow-md"></div>
              <span className="text-green-700">ì„ íƒ ê°€ëŠ¥</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-yellow-400 rounded-lg shadow-lg animate-pulse"></div>
              <span className="text-yellow-700">ë°°ì • ì‹œë„ ì¤‘</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-blue-600 rounded-lg shadow-xl"></div>
              <span className="text-blue-700">ë°°ì • ì™„ë£Œ (DBì— ê¸°ë¡ë¨)</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
